<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Firefly â€” Route Builder</title>
    <link rel="stylesheet" href="/static/css/routes.css">
</head>
<body>

<a href="/" class="back-btn">BACK</a>

<div class="builder-box">

    <h1 class="title">FIND EXPERIENCE</h1>

    <div class="difficulty-select">
        <div class="difficulty-card" data-level="1"><span class="card-text">EASY</span></div>
        <div class="difficulty-card" data-level="2"><span class="card-text">MEDIUM</span></div>
        <div class="difficulty-card" data-level="3"><span class="card-text">HARD</span></div>
    </div>

    <div class="points-select">
        <div class="points-header" id="pointsHeader">
            <span class="points-label">INTEREST POINTS</span>
            <span class="points-counter" id="pointsCounter">0 selected</span>
        </div>

        <div class="points-dropdown" id="pointsDropdown">
        </div>
    </div>

    <button class="generate-btn" onclick="generateRoute()">GENERATE</button>

</div>

<script>
let selectedDifficulty = null;
let selectedPoints = [];
let selectedStartPoint = null;


document.querySelectorAll(".difficulty-card").forEach(card => {
    card.addEventListener("click", () => {
        document.querySelectorAll(".difficulty-card").forEach(c => c.classList.remove("active"));
        card.classList.add("active");
        selectedDifficulty = Number(card.dataset.level);
    });
});


const dropdown = document.getElementById("pointsDropdown");
const header = document.getElementById("pointsHeader");
const counter = document.getElementById("pointsCounter");

header.addEventListener("click", () => {
    dropdown.classList.toggle("open");
});


async function loadPoints() {
    const res = await fetch("/api/pois");
    const points = await res.json();

    dropdown.innerHTML = "";

    points.forEach(p => {
        const item = document.createElement("label");
        item.className = "point-item";

        item.innerHTML = `
            <input type="checkbox" value="${p.id}">
            <span>${p.name}</span>
        `;

        const checkbox = item.querySelector("input");

        checkbox.addEventListener("change", () => {
            if (checkbox.checked) {
                selectedPoints.push(p.id);
                if (!selectedStartPoint) selectedStartPoint = p.id;
            } else {
                selectedPoints = selectedPoints.filter(id => id !== p.id);
                if (selectedStartPoint === p.id) {
                    selectedStartPoint = selectedPoints[0] || null;
                }
            }

            counter.textContent = `${selectedPoints.length} selected`;
        });

        dropdown.appendChild(item);
    });
}

loadPoints();

async function generateRoute() {

    if (!selectedDifficulty || selectedPoints.length === 0 || !selectedStartPoint) {
        alert("Select difficulty and points");
        return;
    }

    const response = await fetch("/api/find-route", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            start_id: selectedStartPoint,
            must_visit: selectedPoints,
            difficulty: selectedDifficulty
        })
    });

    if (!response.ok) {
        alert("Route build error");
        return;
    }

    const result = await response.json();

    sessionStorage.setItem("routeResult", JSON.stringify(result));
    window.location.href = "/route/result";
}
</script>

</body>
</html>
