<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Firefly ‚Äî –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞</title>
    <link rel="stylesheet" href="/static/css/routes.css">
</head>
<body>
   
    <a href="/" class="back-btn">BACK</a>

    <div class="builder-box">

        <h1 class="title">FIND EXPERIENCE</h1>

        <div class="inputs-row">
            <div class="input-block">
                <label>START</label>
                <input id="from_id" type="number" placeholder="ID –Ω–∞—á–∞–ª—å–Ω–æ–π —Ç–æ—á–∫–∏">
            </div>

            <div class="input-block">
                <label>FINISH</label>
                <input id="to_id" type="number" placeholder="ID –∫–æ–Ω–µ—á–Ω–æ–π —Ç–æ—á–∫–∏">
            </div>
        </div>

        <button id="findRoute" class="generate-btn">GENERATE</button>

        <div id="error" class="error" style="display:none;">
            <p id="errorMessage"></p>
        </div>

        <div id="loading" class="loading" style="display:none;">
            <p>–ü–æ–∏—Å–∫ –º–∞—Ä—à—Ä—É—Ç–∞...</p>
        </div>

        <div id="result" class="result-block" style="display:none;">
            <h2>RESULT</h2>
            <div id="resultContent"></div>
        </div>

    </div>

    <script>
        function escapeHtml(unsafe) {
            if (!unsafe) return "";
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        document.getElementById('findRoute').addEventListener('click', async () => {
            const fromId = document.getElementById('from_id').value;
            const toId = document.getElementById('to_id').value;

            if (!fromId || !toId) return showError('please, determ 2 points');
            if (fromId === toId) return showError('start and finish points must be differente');

            showLoading(true);
            hideError();
            hideResult();

            try {
                const response = await fetch(`/route?from_id=${fromId}&to_id=${toId}`);
                const data = await response.json();

                if (!response.ok) {
                    showError(data.detail || 'ERROR of finding a route');
                    return;
                }

                displayResult(data);
            } catch (error) {
                showError('ERROR: can`t connect to server' + error.message);
            } finally {
                showLoading(false);
            }
        });

        document.getElementById('from_id').addEventListener('keypress', e => {
            if (e.key === 'Enter') document.getElementById('findRoute').click();
        });

        document.getElementById('to_id').addEventListener('keypress', e => {
            if (e.key === 'Enter') document.getElementById('findRoute').click();
        });

        function displayResult(data) {
            const resultContent = document.getElementById('resultContent');
            let html = '';

            if (data.points && data.points.length) {
                data.points.forEach((p, idx) => {
                    html += `
                        <div class="point-card">
                            <div class="point-title">
                                <div class="point-number">${idx + 1}</div>
                                ${escapeHtml(p.name)}
                                <span style="opacity:0.8">¬∑ ID: ${p.id}</span>
                            </div>

                            <div class="point-info">
                                <span>üõ∞Ô∏ècoord: <b>${p.lat}, ${p.lon}</b></span>
                                <span>üèîÔ∏èhigh: <b>${p.elevation} –º</b></span>
                                <span>‚õ∫type: <b>${escapeHtml(p.category)}</b></span>
                            </div>
                        </div>`;
                });

                html += `
                    <div class="summary-box">
                        –î–∏—Å—Ç–∞–Ω—Ü–∏—è: <b>${escapeHtml(data.distance_km)} –∫–º</b>
                        &nbsp;‚Ä¢&nbsp;
                        –ù–∞–±–æ—Ä –≤—ã—Å–æ—Ç—ã: <b>${escapeHtml(data.elevation_gain_m)} –º</b>
                    </div>`;
            }

            resultContent.innerHTML = html;
            document.getElementById('result').style.display = 'block';
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('error').style.display = 'block';
        }
        function hideError() { document.getElementById('error').style.display = 'none'; }
        function hideResult() { document.getElementById('result').style.display = 'none'; }
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
    </script>
</body>
</html>
